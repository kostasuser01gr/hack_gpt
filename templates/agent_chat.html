<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HackGPT Agent</title>
<style>
/* â”€â”€ Reset & Variables â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
:root {
  --bg-primary: #0d1117;
  --bg-secondary: #161b22;
  --bg-tertiary: #21262d;
  --bg-chat: #0d1117;
  --text-primary: #e6edf3;
  --text-secondary: #8b949e;
  --text-muted: #6e7681;
  --accent: #58a6ff;
  --accent-hover: #79c0ff;
  --green: #3fb950;
  --red: #f85149;
  --orange: #d29922;
  --border: #30363d;
  --user-bg: #1c2333;
  --assistant-bg: transparent;
  --shadow: 0 2px 8px rgba(0,0,0,0.3);
  --radius: 12px;
  --sidebar-width: 280px;
  --font: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
  --mono: 'SF Mono', 'Fira Code', 'Consolas', monospace;
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html, body { height: 100%; overflow: hidden; }
body {
  font-family: var(--font);
  background: var(--bg-primary);
  color: var(--text-primary);
  display: flex;
}

/* â”€â”€ Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sidebar {
  width: var(--sidebar-width);
  background: var(--bg-secondary);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  flex-shrink: 0;
  transition: transform 0.2s;
}
.sidebar.collapsed { transform: translateX(-100%); position: absolute; z-index: 10; height: 100%; }
.sidebar-header {
  padding: 16px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.sidebar-header h2 { font-size: 16px; font-weight: 600; }
.new-chat-btn {
  background: var(--accent);
  color: #000;
  border: none;
  padding: 8px 16px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 13px;
  font-weight: 600;
}
.new-chat-btn:hover { background: var(--accent-hover); }
.sidebar-search {
  padding: 8px 16px;
  border-bottom: 1px solid var(--border);
}
.sidebar-search input {
  width: 100%;
  padding: 8px 12px;
  background: var(--bg-tertiary);
  border: 1px solid var(--border);
  border-radius: 8px;
  color: var(--text-primary);
  font-size: 13px;
  outline: none;
}
.sidebar-search input:focus { border-color: var(--accent); }
.chat-list {
  flex: 1;
  overflow-y: auto;
  padding: 8px;
}
.chat-item {
  padding: 10px 12px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 13px;
  color: var(--text-secondary);
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 2px;
  position: relative;
}
.chat-item:hover { background: var(--bg-tertiary); color: var(--text-primary); }
.chat-item.active { background: var(--bg-tertiary); color: var(--text-primary); }
.chat-item .pin-icon { color: var(--orange); font-size: 11px; }
.chat-item .title { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.chat-item .actions { display: none; gap: 4px; }
.chat-item:hover .actions { display: flex; }
.chat-item .actions button {
  background: none;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  font-size: 12px;
  padding: 2px 4px;
}
.chat-item .actions button:hover { color: var(--text-primary); }

/* Workspace selector */
.workspace-selector {
  padding: 12px 16px;
  border-top: 1px solid var(--border);
}
.workspace-selector select {
  width: 100%;
  padding: 6px 8px;
  background: var(--bg-tertiary);
  border: 1px solid var(--border);
  border-radius: 6px;
  color: var(--text-primary);
  font-size: 12px;
}
.workspace-selector label { font-size: 11px; color: var(--text-muted); display: block; margin-bottom: 4px; }

/* Usage footer */
.sidebar-footer {
  padding: 12px 16px;
  border-top: 1px solid var(--border);
  font-size: 11px;
  color: var(--text-muted);
}

/* â”€â”€ Main area â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.main {
  flex: 1;
  display: flex;
  flex-direction: column;
  min-width: 0;
}
.topbar {
  padding: 8px 16px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 12px;
  background: var(--bg-secondary);
}
.topbar .toggle-sidebar {
  background: none;
  border: none;
  color: var(--text-secondary);
  cursor: pointer;
  font-size: 18px;
}
.topbar .model-badge {
  font-size: 12px;
  padding: 3px 10px;
  border-radius: 12px;
  background: var(--bg-tertiary);
  color: var(--text-secondary);
  border: 1px solid var(--border);
}

/* Tool toggles */
.tool-toggles {
  display: flex;
  gap: 6px;
  margin-left: auto;
}
.tool-toggle {
  font-size: 11px;
  padding: 4px 10px;
  border-radius: 12px;
  border: 1px solid var(--border);
  background: var(--bg-tertiary);
  color: var(--text-muted);
  cursor: pointer;
  transition: all 0.15s;
}
.tool-toggle.active {
  background: rgba(88,166,255,0.15);
  color: var(--accent);
  border-color: var(--accent);
}

/* â”€â”€ Chat messages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.chat-area {
  flex: 1;
  overflow-y: auto;
  padding: 20px 0;
}
.messages-container {
  max-width: 800px;
  margin: 0 auto;
  padding: 0 20px;
}
.message {
  margin-bottom: 24px;
  animation: fadeIn 0.2s ease;
}
@keyframes fadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; } }
.message .role-label {
  font-size: 12px;
  font-weight: 600;
  margin-bottom: 6px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.message.user .role-label { color: var(--accent); }
.message.assistant .role-label { color: var(--green); }
.message .content {
  font-size: 14px;
  line-height: 1.7;
  white-space: pre-wrap;
  word-break: break-word;
}
.message.user .content {
  background: var(--user-bg);
  padding: 12px 16px;
  border-radius: var(--radius);
}
.message .msg-actions {
  display: none;
  gap: 6px;
  margin-top: 8px;
}
.message:hover .msg-actions { display: flex; }
.msg-action-btn {
  font-size: 11px;
  color: var(--text-muted);
  background: none;
  border: 1px solid var(--border);
  padding: 3px 8px;
  border-radius: 6px;
  cursor: pointer;
}
.msg-action-btn:hover { color: var(--text-primary); border-color: var(--text-secondary); }

/* â”€â”€ Tool traces â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.tool-trace {
  margin: 8px 0;
  padding: 8px 12px;
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: 8px;
  font-size: 12px;
}
.tool-trace .tool-name { color: var(--orange); font-weight: 600; }
.tool-trace .tool-status { color: var(--green); margin-left: 8px; }
.tool-trace .tool-duration { color: var(--text-muted); margin-left: 8px; }

/* â”€â”€ Citations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.citations {
  margin-top: 12px;
  padding: 10px 14px;
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: 8px;
}
.citations-title { font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px; }
.citation-item {
  display: block;
  font-size: 12px;
  color: var(--accent);
  text-decoration: none;
  padding: 3px 0;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.citation-item:hover { color: var(--accent-hover); text-decoration: underline; }

/* â”€â”€ Code outputs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.code-output {
  margin: 10px 0;
  border: 1px solid var(--border);
  border-radius: 8px;
  overflow: hidden;
}
.code-output-header {
  padding: 6px 12px;
  background: var(--bg-tertiary);
  font-size: 11px;
  color: var(--text-muted);
  border-bottom: 1px solid var(--border);
}
.code-output pre {
  padding: 12px;
  overflow-x: auto;
  font-size: 13px;
  font-family: var(--mono);
  background: var(--bg-secondary);
  color: var(--text-primary);
  margin: 0;
}
.code-output .stdout {
  padding: 8px 12px;
  background: rgba(63,185,80,0.05);
  border-top: 1px solid var(--border);
  font-size: 12px;
  font-family: var(--mono);
  color: var(--green);
  white-space: pre-wrap;
}

/* â”€â”€ Generated images â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.generated-image {
  margin: 10px 0;
  border-radius: 8px;
  overflow: hidden;
  max-width: 512px;
  border: 1px solid var(--border);
}
.generated-image img { width: 100%; display: block; }
.generated-image .image-prompt {
  padding: 6px 12px;
  font-size: 11px;
  color: var(--text-muted);
  background: var(--bg-secondary);
}

/* â”€â”€ Typing indicator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.typing-indicator {
  display: none;
  align-items: center;
  gap: 6px;
  padding: 8px 0;
  font-size: 13px;
  color: var(--text-muted);
}
.typing-indicator.visible { display: flex; }
.typing-dots { display: flex; gap: 3px; }
.typing-dots span {
  width: 6px; height: 6px;
  border-radius: 50%;
  background: var(--text-muted);
  animation: blink 1.4s infinite both;
}
.typing-dots span:nth-child(2) { animation-delay: 0.2s; }
.typing-dots span:nth-child(3) { animation-delay: 0.4s; }
@keyframes blink { 0%, 80%, 100% { opacity: 0.3; } 40% { opacity: 1; } }

/* â”€â”€ Input area â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.input-area {
  padding: 16px 20px;
  border-top: 1px solid var(--border);
  background: var(--bg-secondary);
}
.input-container {
  max-width: 800px;
  margin: 0 auto;
  display: flex;
  gap: 8px;
  align-items: flex-end;
}
.input-wrapper {
  flex: 1;
  display: flex;
  align-items: flex-end;
  background: var(--bg-tertiary);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 4px;
  transition: border-color 0.15s;
}
.input-wrapper:focus-within { border-color: var(--accent); }
.input-wrapper textarea {
  flex: 1;
  background: transparent;
  border: none;
  color: var(--text-primary);
  font-size: 14px;
  font-family: var(--font);
  padding: 8px 12px;
  resize: none;
  outline: none;
  max-height: 200px;
  min-height: 40px;
  line-height: 1.5;
}
.attach-btn, .send-btn, .stop-btn {
  border: none;
  border-radius: 8px;
  padding: 8px 12px;
  cursor: pointer;
  font-size: 14px;
  display: flex;
  align-items: center;
  justify-content: center;
}
.attach-btn {
  background: transparent;
  color: var(--text-muted);
}
.attach-btn:hover { color: var(--text-primary); }
.send-btn {
  background: var(--accent);
  color: #000;
  font-weight: 600;
}
.send-btn:disabled { opacity: 0.4; cursor: not-allowed; }
.stop-btn {
  background: var(--red);
  color: white;
  display: none;
}
.stop-btn.visible { display: flex; }

/* â”€â”€ Attachments preview â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.attachments-preview {
  display: flex;
  gap: 6px;
  padding: 4px 8px;
  flex-wrap: wrap;
}
.attachment-chip {
  font-size: 11px;
  padding: 3px 8px;
  background: var(--bg-tertiary);
  border: 1px solid var(--border);
  border-radius: 6px;
  color: var(--text-secondary);
  display: flex;
  align-items: center;
  gap: 4px;
}
.attachment-chip .remove {
  cursor: pointer;
  color: var(--text-muted);
  font-weight: bold;
}

/* â”€â”€ Empty state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.empty-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100%;
  color: var(--text-muted);
  gap: 16px;
}
.empty-state h1 { font-size: 28px; color: var(--text-primary); font-weight: 700; }
.empty-state p { font-size: 14px; max-width: 500px; text-align: center; line-height: 1.6; }

/* â”€â”€ Scrollbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--bg-tertiary); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--border); }

/* â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media (max-width: 768px) {
  .sidebar { position: absolute; z-index: 10; height: 100%; transform: translateX(-100%); }
  .sidebar.open { transform: translateX(0); }
}
</style>
</head>
<body>

<!-- Sidebar -->
<aside class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <h2>ğŸ›¡ï¸ HackGPT</h2>
    <button class="new-chat-btn" onclick="newChat()">+ New</button>
  </div>
  <div class="sidebar-search">
    <input type="text" placeholder="Search chats..." oninput="filterChats(this.value)">
  </div>
  <div class="chat-list" id="chatList"></div>
  <div class="workspace-selector">
    <label>ğŸ“‚ Workspace</label>
    <select id="workspaceSelect" onchange="selectWorkspace(this.value)">
      <option value="">None (general)</option>
    </select>
  </div>
  <div class="sidebar-footer" id="usageFooter">
    Today: 0 requests Â· 0 tokens Â· $0.00
  </div>
</aside>

<!-- Main -->
<div class="main">
  <div class="topbar">
    <button class="toggle-sidebar" onclick="toggleSidebar()">â˜°</button>
    <span class="model-badge" id="modelBadge">gpt-4o</span>
    <div class="tool-toggles" id="toolToggles">
      <button class="tool-toggle" data-tool="web_search" onclick="toggleTool(this)">ğŸ” Search</button>
      <button class="tool-toggle" data-tool="code_interpreter" onclick="toggleTool(this)">ğŸ’» Code</button>
      <button class="tool-toggle" data-tool="image_generation" onclick="toggleTool(this)">ğŸ¨ Image</button>
    </div>
  </div>

  <div class="chat-area" id="chatArea">
    <div class="messages-container" id="messages">
      <div class="empty-state" id="emptyState">
        <h1>HackGPT Agent</h1>
        <p>AI-powered cybersecurity assistant with web search, code execution, file analysis, and image generation.</p>
      </div>
    </div>
    <div class="typing-indicator" id="typingIndicator">
      <div class="typing-dots"><span></span><span></span><span></span></div>
      <span id="typingLabel">Thinking...</span>
    </div>
  </div>

  <div class="input-area">
    <div class="input-container">
      <div class="input-wrapper">
        <button class="attach-btn" onclick="document.getElementById('fileInput').click()" title="Attach file">ğŸ“</button>
        <textarea id="userInput" placeholder="Message HackGPT..." rows="1"
          onkeydown="handleKey(event)" oninput="autoResize(this)"></textarea>
        <input type="file" id="fileInput" multiple hidden onchange="handleFiles(this.files)">
      </div>
      <button class="send-btn" id="sendBtn" onclick="sendMessage()">â†‘</button>
      <button class="stop-btn" id="stopBtn" onclick="stopGeneration()">â–  Stop</button>
    </div>
    <div class="attachments-preview" id="attachmentsPreview"></div>
  </div>
</div>

<script>
// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const API = '/api/agent';
let conversations = [];
let currentConvId = null;
let currentMessages = [];
let isStreaming = false;
let abortController = null;
let toolOverrides = {};
let attachments = [];
let currentWorkspaceId = '';

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('DOMContentLoaded', () => {
  loadHealth();
  loadConversations();
  loadWorkspaces();
  loadUsage();
  document.getElementById('userInput').focus();
});

async function loadHealth() {
  try {
    const r = await fetch(API + '/health');
    const d = await r.json();
    document.getElementById('modelBadge').textContent = d.model || 'gpt-4o';
    // Set tool toggle states from server config
    Object.entries(d.features || {}).forEach(([k, v]) => {
      const btn = document.querySelector(`[data-tool="${k}"]`);
      if (btn && v) { btn.classList.add('active'); toolOverrides[k] = true; }
    });
  } catch(e) { console.warn('Health check failed', e); }
}

async function loadConversations() {
  try {
    const r = await fetch(API + '/conversations', { headers: { 'X-User-ID': 'user1' } });
    const d = await r.json();
    conversations = d.conversations || [];
    renderChatList();
  } catch(e) { console.warn('Failed to load conversations', e); }
}

async function loadWorkspaces() {
  try {
    const r = await fetch(API + '/workspaces', { headers: { 'X-User-ID': 'user1' } });
    const d = await r.json();
    const sel = document.getElementById('workspaceSelect');
    sel.innerHTML = '<option value="">None (general)</option>';
    (d.workspaces || []).forEach(ws => {
      sel.innerHTML += `<option value="${ws.id}">${ws.name} (${ws.files?.length || 0} files)</option>`;
    });
  } catch(e) {}
}

async function loadUsage() {
  try {
    const r = await fetch(API + '/usage', { headers: { 'X-User-ID': 'user1' } });
    const d = await r.json();
    document.getElementById('usageFooter').textContent =
      `Today: ${d.daily_requests} req Â· ${d.daily_tokens} tok Â· $${d.daily_cost_usd?.toFixed(3) || '0.000'}`;
  } catch(e) {}
}

// â”€â”€ Chat list â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderChatList() {
  const el = document.getElementById('chatList');
  el.innerHTML = conversations.map(c => `
    <div class="chat-item ${c.id === currentConvId ? 'active' : ''}" onclick="loadChat('${c.id}')">
      ${c.pinned ? '<span class="pin-icon">ğŸ“Œ</span>' : ''}
      <span class="title">${escHtml(c.title)}</span>
      <span class="actions">
        <button onclick="event.stopPropagation(); pinChat('${c.id}')" title="Pin">ğŸ“Œ</button>
        <button onclick="event.stopPropagation(); deleteChat('${c.id}')" title="Delete">ğŸ—‘</button>
      </span>
    </div>
  `).join('');
}

function filterChats(q) {
  const items = document.querySelectorAll('.chat-item');
  items.forEach(el => {
    el.style.display = el.textContent.toLowerCase().includes(q.toLowerCase()) ? '' : 'none';
  });
}

// â”€â”€ Chat actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function newChat() {
  currentConvId = null;
  currentMessages = [];
  document.getElementById('messages').innerHTML = `
    <div class="empty-state" id="emptyState">
      <h1>HackGPT Agent</h1>
      <p>AI-powered cybersecurity assistant with web search, code execution, file analysis, and image generation.</p>
    </div>`;
  renderChatList();
  document.getElementById('userInput').focus();
}

async function loadChat(id) {
  try {
    const r = await fetch(API + '/conversations/' + id, { headers: { 'X-User-ID': 'user1' } });
    const d = await r.json();
    currentConvId = d.id;
    currentMessages = d.messages || [];
    renderMessages();
    renderChatList();
  } catch(e) { console.error('Failed to load chat', e); }
}

async function deleteChat(id) {
  await fetch(API + '/conversations/' + id, { method: 'DELETE', headers: { 'X-User-ID': 'user1' } });
  if (currentConvId === id) newChat();
  loadConversations();
}

async function pinChat(id) {
  await fetch(API + '/conversations/' + id + '/pin', {
    method: 'POST', headers: { 'Content-Type': 'application/json', 'X-User-ID': 'user1' },
    body: JSON.stringify({ pinned: true })
  });
  loadConversations();
}

function selectWorkspace(id) { currentWorkspaceId = id; }

// â”€â”€ Render messages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderMessages() {
  const container = document.getElementById('messages');
  container.innerHTML = currentMessages.map((m, i) => renderMessage(m, i)).join('');
  scrollToBottom();
}

function renderMessage(m, idx) {
  const isUser = m.role === 'user';
  let html = `<div class="message ${m.role}" data-idx="${idx}">`;
  html += `<div class="role-label">${isUser ? 'ğŸ‘¤ You' : 'ğŸ¤– HackGPT'}</div>`;
  html += `<div class="content">${formatContent(m.content)}</div>`;

  // Tool traces
  if (m.tool_traces?.length) {
    m.tool_traces.forEach(t => {
      html += `<div class="tool-trace">
        <span class="tool-name">${toolIcon(t.tool_name)} ${t.tool_name}</span>
        <span class="tool-status">âœ“</span>
        ${t.duration_ms ? `<span class="tool-duration">${t.duration_ms}ms</span>` : ''}
      </div>`;
    });
  }

  // Citations
  if (m.citations?.length) {
    html += `<div class="citations"><div class="citations-title">ğŸ“š Sources</div>`;
    m.citations.forEach((c, i) => {
      html += `<a class="citation-item" href="${escHtml(c.url)}" target="_blank">[${i+1}] ${escHtml(c.title || c.url)}</a>`;
    });
    html += `</div>`;
  }

  // Code outputs
  if (m.code_outputs?.length) {
    m.code_outputs.forEach(co => {
      html += `<div class="code-output">
        <div class="code-output-header">Python</div>
        <pre>${escHtml(co.code)}</pre>
        ${co.stdout ? `<div class="stdout">${escHtml(co.stdout)}</div>` : ''}
      </div>`;
    });
  }

  // Images
  if (m.images?.length) {
    m.images.forEach(img => {
      if (img.url) {
        html += `<div class="generated-image">
          <img src="${img.url}" alt="Generated image" loading="lazy">
          ${img.revised_prompt ? `<div class="image-prompt">${escHtml(img.revised_prompt)}</div>` : ''}
        </div>`;
      }
    });
  }

  // Action buttons
  if (isUser) {
    html += `<div class="msg-actions">
      <button class="msg-action-btn" onclick="editMessage(${idx})">âœï¸ Edit</button>
    </div>`;
  } else {
    html += `<div class="msg-actions">
      <button class="msg-action-btn" onclick="regenerateMessage(${idx})">ğŸ”„ Regenerate</button>
      <button class="msg-action-btn" onclick="copyMessage(${idx})">ğŸ“‹ Copy</button>
    </div>`;
  }

  html += `</div>`;
  return html;
}

function toolIcon(name) {
  const icons = { 'web_search_preview': 'ğŸ”', 'file_search': 'ğŸ“„', 'code_interpreter': 'ğŸ’»', 'image_generation': 'ğŸ¨' };
  return icons[name] || 'ğŸ”§';
}

function formatContent(text) {
  if (!text) return '';
  // Basic markdown: bold, italic, code blocks, inline code
  let html = escHtml(text);
  html = html.replace(/```(\w*)\n([\s\S]*?)```/g, '<pre class="code-block"><code>$2</code></pre>');
  html = html.replace(/`([^`]+)`/g, '<code style="background:var(--bg-tertiary);padding:2px 5px;border-radius:4px;font-size:13px;">$1</code>');
  html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
  html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');
  return html;
}

// â”€â”€ Send message â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function sendMessage() {
  const input = document.getElementById('userInput');
  const text = input.value.trim();
  if (!text || isStreaming) return;

  // Clear empty state
  const empty = document.getElementById('emptyState');
  if (empty) empty.remove();

  // Add user message
  const userMsg = { role: 'user', content: text, citations: [], images: [], code_outputs: [], tool_traces: [] };
  currentMessages.push(userMsg);
  const container = document.getElementById('messages');
  container.innerHTML += renderMessage(userMsg, currentMessages.length - 1);
  input.value = '';
  autoResize(input);
  scrollToBottom();

  // Start streaming
  isStreaming = true;
  document.getElementById('sendBtn').style.display = 'none';
  document.getElementById('stopBtn').classList.add('visible');
  showTyping('Thinking...');

  abortController = new AbortController();

  try {
    const body = {
      message: text,
      conversation_id: currentConvId,
      workspace_id: currentWorkspaceId || undefined,
      tools: toolOverrides,
    };

    const resp = await fetch(API + '/chat/stream', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-User-ID': 'user1' },
      body: JSON.stringify(body),
      signal: abortController.signal,
    });

    const reader = resp.body.getReader();
    const decoder = new TextDecoder();

    let assistantMsg = { role: 'assistant', content: '', citations: [], images: [], code_outputs: [], tool_traces: [] };
    currentMessages.push(assistantMsg);
    const msgIdx = currentMessages.length - 1;

    // Add placeholder
    container.innerHTML += `<div class="message assistant" id="streamMsg" data-idx="${msgIdx}">
      <div class="role-label">ğŸ¤– HackGPT</div>
      <div class="content" id="streamContent"></div>
      <div id="streamExtras"></div>
    </div>`;
    scrollToBottom();

    let buffer = '';
    while (true) {
      const { value, done } = await reader.read();
      if (done) break;
      buffer += decoder.decode(value, { stream: true });

      const lines = buffer.split('\n');
      buffer = lines.pop(); // Keep incomplete line

      for (const line of lines) {
        if (!line.startsWith('data: ')) continue;
        try {
          const chunk = JSON.parse(line.slice(6));
          handleStreamChunk(chunk, assistantMsg);
        } catch(e) {}
      }
    }

    hideTyping();
    // Re-render the final message properly
    const streamEl = document.getElementById('streamMsg');
    if (streamEl) {
      streamEl.outerHTML = renderMessage(assistantMsg, msgIdx);
    }

    // Update conversation ID from done event
    if (!currentConvId && assistantMsg._convId) {
      currentConvId = assistantMsg._convId;
    }

  } catch(e) {
    if (e.name !== 'AbortError') {
      console.error('Stream error', e);
      const errMsg = { role: 'assistant', content: 'âŒ Error: ' + e.message, citations: [], images: [], code_outputs: [], tool_traces: [] };
      currentMessages.push(errMsg);
      container.innerHTML += renderMessage(errMsg, currentMessages.length - 1);
    }
  } finally {
    isStreaming = false;
    document.getElementById('sendBtn').style.display = '';
    document.getElementById('stopBtn').classList.remove('visible');
    hideTyping();
    loadConversations();
    loadUsage();
    scrollToBottom();
  }
}

function handleStreamChunk(chunk, msg) {
  const contentEl = document.getElementById('streamContent');
  const extrasEl = document.getElementById('streamExtras');

  switch (chunk.type) {
    case 'text_delta':
      msg.content += chunk.content;
      if (contentEl) contentEl.innerHTML = formatContent(msg.content);
      hideTyping();
      scrollToBottom();
      break;
    case 'tool_start':
      showTyping(`Using ${toolIcon(chunk.tool)} ${chunk.tool}...`);
      break;
    case 'tool_done':
      msg.tool_traces.push({ tool_name: chunk.tool, status: 'completed', duration_ms: chunk.duration_ms });
      if (extrasEl) {
        extrasEl.innerHTML += `<div class="tool-trace">
          <span class="tool-name">${toolIcon(chunk.tool)} ${chunk.tool}</span>
          <span class="tool-status">âœ“</span>
          <span class="tool-duration">${chunk.duration_ms}ms</span>
        </div>`;
      }
      hideTyping();
      break;
    case 'citation':
      msg.citations.push({ title: chunk.title, url: chunk.url });
      break;
    case 'image':
      msg.images.push({ url: chunk.url, revised_prompt: chunk.revised_prompt });
      if (extrasEl && chunk.url) {
        extrasEl.innerHTML += `<div class="generated-image">
          <img src="${chunk.url}" alt="Generated" loading="lazy">
          ${chunk.revised_prompt ? `<div class="image-prompt">${escHtml(chunk.revised_prompt)}</div>` : ''}
        </div>`;
      }
      scrollToBottom();
      break;
    case 'code_output':
      msg.code_outputs.push({ code: chunk.code, stdout: chunk.stdout, files: chunk.files });
      if (extrasEl) {
        extrasEl.innerHTML += `<div class="code-output">
          <div class="code-output-header">Python</div>
          <pre>${escHtml(chunk.code)}</pre>
          ${chunk.stdout ? `<div class="stdout">${escHtml(chunk.stdout)}</div>` : ''}
        </div>`;
      }
      scrollToBottom();
      break;
    case 'done':
      if (chunk.message?.id) msg._convId = chunk.message.conversation_id;
      break;
    case 'error':
      msg.content += '\nâŒ ' + chunk.message;
      if (contentEl) contentEl.innerHTML = formatContent(msg.content);
      break;
  }
}

// â”€â”€ Edit & Regenerate â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function editMessage(idx) {
  const msg = currentMessages[idx];
  if (!msg || msg.role !== 'user') return;
  // Truncate messages after this one
  currentMessages = currentMessages.slice(0, idx);
  renderMessages();
  document.getElementById('userInput').value = msg.content;
  document.getElementById('userInput').focus();
}

function regenerateMessage(idx) {
  // Find the preceding user message
  for (let i = idx - 1; i >= 0; i--) {
    if (currentMessages[i].role === 'user') {
      const userText = currentMessages[i].content;
      currentMessages = currentMessages.slice(0, i);
      renderMessages();
      document.getElementById('userInput').value = userText;
      sendMessage();
      return;
    }
  }
}

function copyMessage(idx) {
  const msg = currentMessages[idx];
  if (msg) navigator.clipboard.writeText(msg.content);
}

// â”€â”€ Stop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function stopGeneration() {
  if (abortController) abortController.abort();
}

// â”€â”€ Tool toggles â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleTool(btn) {
  const tool = btn.dataset.tool;
  btn.classList.toggle('active');
  toolOverrides[tool] = btn.classList.contains('active');
}

// â”€â”€ File attachments â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleFiles(files) {
  const preview = document.getElementById('attachmentsPreview');
  for (const f of files) {
    attachments.push(f);
    const chip = document.createElement('span');
    chip.className = 'attachment-chip';
    chip.innerHTML = `ğŸ“ ${escHtml(f.name)} <span class="remove" onclick="removeAttachment(this, '${f.name}')">Ã—</span>`;
    preview.appendChild(chip);
  }
}
function removeAttachment(el, name) {
  attachments = attachments.filter(a => a.name !== name);
  el.parentElement.remove();
}

// â”€â”€ Sidebar toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('collapsed');
}

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function autoResize(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 200) + 'px';
}
function handleKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
}
function scrollToBottom() {
  const area = document.getElementById('chatArea');
  requestAnimationFrame(() => { area.scrollTop = area.scrollHeight; });
}
function showTyping(label) {
  const el = document.getElementById('typingIndicator');
  document.getElementById('typingLabel').textContent = label;
  el.classList.add('visible');
}
function hideTyping() {
  document.getElementById('typingIndicator').classList.remove('visible');
}
function escHtml(s) {
  if (!s) return '';
  const div = document.createElement('div');
  div.textContent = s;
  return div.innerHTML;
}
</script>
</body>
</html>
